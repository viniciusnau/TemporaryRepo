CKEDITOR.plugins.add("tags",{requires:"autocomplete,textmatch",onLoad:function(){function b(a,e){d.call(this,a,e)}var d=CKEDITOR.plugins.autocomplete;b.prototype=CKEDITOR.tools.prototypedCopy(d.prototype);b.prototype.commit=function(a){if(this.model.isActive){this.close();if(null==a&&(a=this.model.selectedItemId,null==a))return;var e=this.model.getItemById(a),c=this.editor,b=this;$.ajax({url:CKEDITOR.config.tag_url,type:"POST",data:{txtTag:a}}).done(function(a,d,f){/#Erro#:/i.test(a)?$("#infoMessage").removeClass().addClass("msgbox error").html(a).fadeOut().fadeIn():
(e.result=a.result,c.fire("saveSnapshot"),c.getSelection().selectRanges([b.model.range]),c.insertHtml(b.getHtmlToInsert(e),"text"),c.fire("saveSnapshot"))}).fail(function(a,b,e){$("#infoMessage").removeClass().addClass("msgbox error").html("Erro ao buscar tag. \x3cbr\x3e"+a.responseText).fadeOut().fadeIn()})}};CKEDITOR.plugins.customAutocomplete=b},init:function(b){b.on("instanceReady",function(){function d(a,b){var c=a.slice(0,b).match(/@\w*$/);return c?{start:c.index,end:b}:null}new CKEDITOR.plugins.customAutocomplete(b,
{textTestCallback:function(a){return a.collapsed?CKEDITOR.plugins.textMatch.match(a,d):null},dataCallback:function(a,b){var c=a.query.substring(1),d=CKEDITOR.config.tags.filter(function(a){return 0==String(a.id).indexOf(c)});b(d)},itemTemplate:'\x3cli data-id\x3d"{id}"\x3e@{id}@: {name}\x3c/li\x3e',outputTemplate:"{result}"})})}});